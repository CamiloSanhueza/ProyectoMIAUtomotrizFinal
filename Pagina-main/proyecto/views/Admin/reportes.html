<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Documentos - MIAUtomotriz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #f4f6f9;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }
    </style>
    <script>
        fetch('../../controllers/API/auth.php?action=check_session')
            .then(res => res.json())
            .then(data => {
                if (!data.success || !data.user || data.user.rol !== 'administrador') {
                    window.location.href = '../login.html';
                } else {
                    const display = document.getElementById('user-display');
                    if (display) display.textContent = 'Bienvenido, ' + data.user.correo;
                }
            })
            .catch(() => window.location.href = '../login.html');
    </script>
</head>

<body>

    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow bg-admin-blue"
            style="background-color: #020e7c !important;">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="../../img/logo.png" alt="logo" height="40" class="me-2">
                    <span>MIAUtomotriz</span>
                </a>
                <div class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item border-end pe-3 me-3 text-white d-flex align-items-center">
                            <small id="user-display">Bienvenido</small>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="dashboard-admin.html">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link" href="reparaciones-admin.html">Órdenes</a></li>
                        <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#">Reportes</a></li>
                        <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
                        <li class="nav-item"><a class="nav-link" href="personal.html">Personal</a></li>
                        <li class="nav-item"><a class="nav-link text-danger"
                                href="../../controllers/API/auth.php?action=logout"><i
                                    class="fas fa-sign-out-alt"></i></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-file-pdf me-2"></i> Generación de Documentos</div>
                <div class="card-body">
                    <p class="text-muted">Busque una orden de trabajo para generar documentos PDF.</p>
                    <div class="row g-3 align-items-end mb-4">

                        <div class="col-md-4"><label class="form-label">Buscar</label><input type="text"
                                class="form-control" v-model="filters.search" placeholder="Patente, Cliente, ID...">
                        </div>
                        <div class="col-md-2"><button class="btn btn-secondary w-100" @click="resetFilters"><i
                                    class="fas fa-undo"></i> Limpiar</button></div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Vehículo</th>
                                    <th>Estado</th>
                                    <th>Documentos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="loadingOrders">
                                    <td colspan="6" class="text-center py-3">Cargando...</td>
                                </tr>
                                <tr v-else-if="filteredOrders.length === 0">
                                    <td colspan="6" class="text-center py-3 text-muted">Sin resultados.</td>
                                </tr>
                                <tr v-else v-for="order in filteredOrders" :key="order.id">
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.fecha_ingreso }}</td>
                                    <td>{{ order.nombre_cliente }}</td>
                                    <td>
                                        <div>{{ order.marca }} {{ order.modelo }}</div><small class="text-muted">{{
                                            order.patente }}</small>
                                    </td>
                                    <td><span class="badge" :class="getStatusClass(order.estado)">{{ order.estado
                                            }}</span></td>
                                    <td>
                                        <button @click="openPDF('orden', order.id)"
                                            class="btn btn-sm btn-outline-dark me-1"><i
                                                class="fas fa-clipboard-list"></i> Orden</button>
                                        <button @click="openPDF('factura', order.id)"
                                            class="btn btn-sm btn-outline-success me-1"><i
                                                class="fas fa-file-invoice-dollar"></i> Factura</button>
                                        <button @click="openPDF('cotizacion', order.id)"
                                            class="btn btn-sm btn-outline-info"><i class="fas fa-calculator"></i>
                                            Cotización</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header text-white bg-admin-dark">Vehículos Más Atendidos
                        </div>
                        <div class="card-body"><canvas id="chartVehiculos"></canvas></div>
                        <div class="card-footer text-center"><button class="btn btn-sm btn-outline-primary"
                                @click="printChart('chartVehiculos','Reporte Vehículos')">Imprimir</button></div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header text-white bg-admin-dark">Repuestos Más Utilizados
                        </div>
                        <div class="card-body"><canvas id="chartRepuestos"></canvas></div>
                        <div class="card-footer text-center"><button class="btn btn-sm btn-outline-success"
                                @click="printChart('chartRepuestos','Reporte Repuestos')">Imprimir</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        /**
         * Aplicación Vue para la sección de Reportes y Documentos.
         * Funcionalidades:
         * 1. Listado de órdenes con filtros avanzados (fecha, texto).
         * 2. Generación de PDFs (Orden, Factura, Cotización).
         * 3. Visualización de gráficos estadísticos con Chart.js.
         */
        createApp({
            data() {
                return {
                    orders: [],         // Lista total de órdenes
                    filters: {          // Modelo para los filtros de búsqueda
                        search: ''
                    },
                    loadingOrders: false // Estado de carga
                };
            },
            computed: {
                /**
                 * Filtra las órdenes según criterios múltiples:
                 * - Texto libre (ID, Patente, Cliente)
                 * - Rango de fechas (Inicio - Fin)
                 */
                filteredOrders() {
                    const search = this.filters.search.toLowerCase().trim();


                    return this.orders.filter(o => {
                        // Coincidencia de texto
                        const matchText = !search ||
                            o.id.toString().includes(search) ||
                            o.patente.toLowerCase().includes(search) ||
                            o.nombre_cliente.toLowerCase().includes(search);



                        return matchText;
                    });
                }
            },
            mounted() {
                this.fetchOrders();
                this.renderCharts();
            },
            methods: {
                /** Carga listado de órdenes APRA generación de documentos */
                async fetchOrders() {
                    this.loadingOrders = true;
                    try {
                        const res = await fetch('../../controllers/API/reparaciones.php');
                        const json = await res.json();
                        if (json.success) this.orders = json.data;
                    } catch (e) { console.error(e); }
                    finally { this.loadingOrders = false; }
                },

                /** Devuelve clase CSS según estado */
                getStatusClass(s) {
                    switch (s) {
                        case 'Completada': return 'bg-success';
                        case 'En Proceso': return 'bg-info text-dark';
                        case 'Pendiente': return 'bg-warning text-dark';
                        case 'Cancelada': return 'bg-danger';
                        default: return 'bg-secondary';
                    }
                },

                /** 
                 * Abre una nueva ventana generando el PDF solicitado.
                 * @param type Tipo de documento: 'orden', 'factura', 'cotizacion'
                 * @param id ID de la orden
                 */
                openPDF(type, id) {
                    window.open(`../../controllers/API/orden_pdf.php?id=${id}&type=${type}`, `PDF`, `width=900,height=1000`);
                },

                /** Limpia los filtros de búsqueda */
                resetFilters() {
                    this.filters = { search: '' };
                },

                /** 
                 * Carga datos estadísticos y renderiza gráficos usando Chart.js
                 * - Gráfico 1: Vehículos más atendidos (Barras)
                 * - Gráfico 2: Repuestos más utilizados (Torta)
                 */
                async renderCharts() {
                    try {
                        // Gráfico de Vehículos
                        const rV = await fetch('../../controllers/API/helpers.php?data=vehiculos');
                        const jV = await rV.json();
                        if (jV.success) {
                            new Chart(document.getElementById('chartVehiculos'), {
                                type: 'bar',
                                data: {
                                    labels: jV.data.map(v => v.marca + ' ' + v.modelo),
                                    datasets: [{
                                        label: 'Atenciones',
                                        data: jV.data.map(v => v.atenciones),
                                        backgroundColor: '#0d6efd'
                                    }]
                                }
                            });
                        }

                        // Gráfico de Repuestos
                        const rR = await fetch('../../controllers/API/helpers.php?data=repuestos');
                        const jR = await rR.json();
                        if (jR.success) {
                            new Chart(document.getElementById('chartRepuestos'), {
                                type: 'pie',
                                data: {
                                    labels: jR.data.map(r => r.nombre),
                                    datasets: [{
                                        data: jR.data.map(r => r.cantidad),
                                        backgroundColor: ['#198754', '#0dcaf0', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#d63384', '#20c997', '#6610f2', '#0d6efd', '#adb5bd', '#343a40']
                                    }]
                                }
                            });
                        }
                    } catch (e) { console.error("Error al cargar gráficos", e); }
                },

                /** 
                 * Imprime el gráfico en una ventana popup 
                 */
                printChart(cId, title) {
                    const win = window.open('', 'Print', 'height=600,width=800');
                    win.document.write(`<html><head><title>${title}</title></head><body style="text-align:center;"><h2>${title}</h2><img src="${document.getElementById(cId).toDataURL()}" style="max-width:100%;"/></body></html>`);
                    win.document.close();
                    setTimeout(() => { win.focus(); win.print(); }, 500);
                }
            }
        }).mount('#app');
    </script>
</body>

</html>