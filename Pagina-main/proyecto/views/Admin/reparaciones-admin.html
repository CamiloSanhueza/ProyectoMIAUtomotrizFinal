<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Órdenes - MiaAutomotriz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        fetch('../../controllers/API/auth.php?action=check_session')
            .then(res => res.json())
            .then(data => {
                if (!data.success || !data.user || data.user.rol !== 'administrador') {
                    window.location.href = '../login.html';
                } else {
                    const display = document.getElementById('user-display');
                    if (display) display.textContent = 'Bienvenido, ' + data.user.correo;
                }
            })
            .catch(() => window.location.href = '../login.html');
    </script>
    <style>
        body {
            background-color: #f4f6f9;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, .02);
        }

        .card-header {
            background-color: #343a40;
            color: white;
        }
    </style>
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow bg-admin-blue">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="../../img/logo.png" alt="logo" height="40" class="me-2">
                    <span>MIAUtomotriz</span>
                </a>
                <div class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item border-end pe-3 me-3 text-white d-flex align-items-center">
                            <small id="user-display">Bienvenido</small>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="dashboard-admin.html">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link active" href="reparaciones-admin.html">Órdenes</a></li>
                        <li class="nav-item"><a class="nav-link" href="inventario.html">Inventario</a></li>
                        <li class="nav-item"><a class="nav-link" href="reportes.html">Reportes</a></li>
                        <li class="nav-item"><a class="nav-link" href="clientes.html">Clientes</a></li>
                        <li class="nav-item"><a class="nav-link" href="personal.html">Personal</a></li>
                        <li class="nav-item"><a class="nav-link text-danger"
                                href="../../controllers/API/auth.php?action=logout"><i
                                    class="fas fa-sign-out-alt"></i></a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container">
            <div class="card shadow">
                <div class="card-header text-white d-flex justify-content-between align-items-center bg-admin-dark">
                    <h4 class="mb-0"><i class="fas fa-tools me-2"></i>Órdenes de Trabajo</h4>
                    <button class="btn btn-success" @click="openModalCreate">
                        <i class="fas fa-plus"></i> Nueva Orden
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Buscar por Patente, Cliente o ID..."
                            v-model="searchQuery">
                    </div>
                    <!-- Tabla y Modal -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Vehículo</th>
                                    <th>Mecánico</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="loading">
                                    <td colspan="6" class="text-center">Cargando...</td>
                                </tr>
                                <tr v-else-if="filteredOrders.length === 0">
                                    <td colspan="6" class="text-center text-muted">No se encontraron órdenes.</td>
                                </tr>
                                <tr v-else v-for="order in filteredOrders" :key="order.id">
                                    <td><strong>{{ order.id }}</strong></td>
                                    <td>{{ order.fecha_ingreso }}</td>
                                    <td>
                                        <div>{{ order.nombre_cliente }}</div>
                                        <small class="text-muted">{{ order.run_cliente }}</small>
                                    </td>
                                    <td>
                                        <div class="badge bg-secondary">{{ order.patente }}</div>
                                        <small class="d-block text-muted">{{ order.marca }} {{ order.modelo }}</small>
                                    </td>
                                    <td>
                                        <span v-if="order.nombre_mecanico" class="badge bg-info text-dark">{{
                                            order.nombre_mecanico }}</span>
                                        <span v-else class="text-muted small">Sin asignar</span>
                                    </td>
                                    <td><span :class="['badge', getStatusClass(order.estado)]">{{ order.estado }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                            @click="openModalEdit(order)" :disabled="order.estado === 'Completada'"
                                            title="No se puede editar una orden completada"><i
                                                class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteOrder(order)"><i
                                                class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="orderModal" tabindex="-1" ref="orderModal">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title">{{ isEdit ? 'Editar Orden #' + form.id : 'Nueva Orden de Trabajo' }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveOrder" novalidate>
                            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab"
                                        data-bs-target="#general" type="button" role="tab" aria-selected="true">Datos
                                        Generales</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="labor-tab" data-bs-toggle="tab" data-bs-target="#labor"
                                        type="button" role="tab" aria-selected="false">Mano de Obra</button>
                                </li>

                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="parts-tab" data-bs-toggle="tab" data-bs-target="#parts"
                                        type="button" role="tab" aria-selected="false">Repuestos</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="myTabContent">
                                <!-- TAB GENERAL -->
                                <div class="tab-pane fade show active" id="general" role="tabpanel"
                                    aria-labelledby="general-tab">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Fecha de Ingreso</label>
                                            <input type="date" class="form-control" v-model="form.fecha_ingreso">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Estado</label>
                                            <select class="form-select" v-model="form.estado">
                                                <option value="Pendiente">Pendiente</option>
                                                <option value="En Proceso">En Proceso</option>
                                                <option value="Completada">Completada</option>
                                                <option value="Cancelada">Cancelada</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Asignar Mecánico</label>
                                        <select class="form-select" v-model="form.id_mecanico">
                                            <option value="">-- Sin Asignar --</option>
                                            <option v-for="m in mechanics" :key="m.id" :value="m.id">{{ m.nombre }} {{
                                                m.apellido }}</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Cliente</label>
                                        <select class="form-select" v-model="form.run_cliente" @change="onClientChange"
                                            :disabled="isEdit">
                                            <option value="">-- Seleccione Cliente --</option>
                                            <option v-for="c in clients" :key="c.id" :value="c.id">{{ c.nombre }} {{
                                                c.apellido }} ({{ c.id }})</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Vehículo</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="form.patente"
                                                :disabled="!form.run_cliente">
                                                <option value="">-- Seleccione Vehículo --</option>
                                                <option v-for="v in vehicles" :key="v.patente" :value="v.patente">{{
                                                    v.marca }} {{ v.modelo }} [{{ v.patente }}]</option>
                                            </select>
                                            <button type="button" class="btn btn-primary"
                                                @click="showNewVehicle = !showNewVehicle" v-if="form.run_cliente"><i
                                                    class="fas"
                                                    :class="showNewVehicle ? 'fa-minus' : 'fa-plus'"></i></button>
                                        </div>
                                    </div>
                                    <!-- Formulario Vehículo Nuevo -->
                                    <div v-if="showNewVehicle" class="card mb-3 bg-light border-success">
                                        <div class="card-body">
                                            <h6 class="card-title text-success">Registrar Nuevo Vehículo</h6>
                                            <div class="row g-2">
                                                <div class="col-md-4"><input type="text"
                                                        class="form-control form-control-sm" placeholder="Patente"
                                                        v-model="newVehicle.patente" maxlength="6"></div>
                                                <div class="col-md-4"><input type="text"
                                                        class="form-control form-control-sm" placeholder="Marca"
                                                        list="marcasList" v-model="newVehicle.marca"><datalist
                                                        id="marcasList">
                                                        <option v-for="m in marcas" :value="m.nombre"></option>
                                                    </datalist></div>
                                                <div class="col-md-4"><input type="text"
                                                        class="form-control form-control-sm" placeholder="Modelo"
                                                        v-model="newVehicle.modelo"></div>
                                                <div class="col-md-4"><input type="text"
                                                        class="form-control form-control-sm" placeholder="Año"
                                                        v-model="newVehicle.anio" maxlength="4"></div>
                                                <div class="col-md-4"><input type="text"
                                                        class="form-control form-control-sm" placeholder="Color"
                                                        v-model="newVehicle.color"></div>
                                                <div class="col-md-4"><button type="button"
                                                        class="btn btn-success btn-sm w-100"
                                                        @click="saveNewVehicle">Guardar</button></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Seguro</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="form.id_seguro"
                                                :disabled="!form.run_cliente">
                                                <option value="">-- Sin Seguro --</option>
                                                <option v-for="s in insurances" :key="s.IDSeguro" :value="s.IDSeguro">{{
                                                    s.EmpresaSeguro }} - {{ s.numeroPoliza }}</option>
                                            </select>
                                            <button type="button" class="btn btn-primary"
                                                @click="showNewInsurance = !showNewInsurance" v-if="form.run_cliente"><i
                                                    class="fas"
                                                    :class="showNewInsurance ? 'fa-minus' : 'fa-plus'"></i></button>
                                        </div>
                                    </div>

                                    <!-- Formulario Seguro Nuevo -->
                                    <div v-if="showNewInsurance" class="card mb-3 bg-light border-primary">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary">Asignar Nuevo Seguro</h6>
                                            <div class="row g-2">
                                                <div class="col-md-5"><input type="text"
                                                        class="form-control form-control-sm"
                                                        placeholder="Empresa (Ej: Mapfre)"
                                                        v-model="newInsurance.empresa"></div>
                                                <div class="col-md-5"><input type="text"
                                                        class="form-control form-control-sm" placeholder="N° Póliza"
                                                        v-model="newInsurance.poliza"></div>
                                                <div class="col-md-2"><button type="button"
                                                        class="btn btn-primary btn-sm w-100"
                                                        @click="saveNewInsurance">Guardar</button></div>
                                                <div class="col-12"><small class="text-muted">Se rellenarán datos de
                                                        contacto por defecto.</small></div>
                                            </div>
                                        </div>
                                    </div>


                                </div>

                                <!-- TAB MANO DE OBRA -->
                                <div class="tab-pane fade" id="labor" role="tabpanel" aria-labelledby="labor-tab">
                                    <div class="mb-3">
                                        <label class="form-label">Agregar Mano de Obra</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="selectedLaborId">
                                                <option value="">-- Seleccionar Tarea --</option>
                                                <option v-for="l in laborList" :key="l.IDManoDeObra"
                                                    :value="l.IDManoDeObra">
                                                    {{ l.nombreTarea }}
                                                </option>
                                            </select>
                                            <button type="button" class="btn btn-primary"
                                                @click="addLabor">Agregar</button>
                                        </div>
                                    </div>

                                    <div v-if="selectedLabor.length > 0">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Tarea</th>
                                                    <th style="width: 100px;">Horas</th>
                                                    <th>Precio Total</th>
                                                    <th style="width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(item, index) in selectedLabor" :key="index">
                                                    <td class="text-wrap text-break">{{ item.nombre }}</td>
                                                    <td><input type="number" class="form-control form-control-sm"
                                                            v-model.number="item.horas" min="0.5" step="0.5"></td>
                                                    <td>${{ item.precio_unitario * item.horas }}</td>
                                                    <td class="text-center"><button type="button"
                                                            class="btn btn-sm btn-danger" @click="removeLabor(index)"><i
                                                                class="fas fa-trash"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div v-else class="alert alert-info py-2">No se ha asignado mano de obra.</div>
                                    <div class="mb-3 mt-4">
                                        <label class="form-label">Inspección de Daños</label>
                                    </div>
                                    <div class="row g-2 mb-3 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label">Tipo de Daño</label>
                                            <select class="form-select form-select-sm" v-model="newDamage.id_tipo">
                                                <option value="">-- Seleccionar --</option>
                                                <option v-for="t in damageTypes" :key="t.TipoDano" :value="t.TipoDano">
                                                    {{ t.DescripcionDano }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Ubicación</label>
                                            <select class="form-select form-select-sm" v-model="newDamage.id_ubicacion">
                                                <option value="">-- Seleccionar --</option>
                                                <option v-for="u in damageLocations" :key="u.IDUbicacionDano"
                                                    :value="u.IDUbicacionDano">{{ u.DescripcionUbicacion }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Observación</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" v-model="newDamage.observacion"
                                                    placeholder="Detalle...">
                                                <button type="button" class="btn btn-success" @click="addDamage">
                                                    Agregar</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div v-if="selectedDamages.length > 0">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Daño</th>
                                                    <th>Ubicación</th>
                                                    <th>Observación</th>
                                                    <th style="width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(item, index) in selectedDamages" :key="index">
                                                    <td class="text-wrap text-break">{{ item.nombre_tipo }}</td>
                                                    <td class="text-wrap">{{ item.nombre_ubicacion }}</td>
                                                    <td class="text-wrap text-break">{{ item.observacion }}</td>
                                                    <td class="text-center"><button type="button"
                                                            class="btn btn-sm btn-danger"
                                                            @click="removeDamage(index)"><i
                                                                class="fas fa-trash"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div v-else class="alert alert-info py-2">No se han registrado daños.</div>
                                </div>

                                <!-- TAB REPUESTOS -->
                                <div class="tab-pane fade" id="parts" role="tabpanel" aria-labelledby="parts-tab">
                                    <div class="row g-2 mb-3 align-items-end">
                                        <div class="col-md-6">
                                            <label class="form-label">Repuesto (Pieza)</label>
                                            <select class="form-select form-select-sm" v-model="newPart.id_pieza">
                                                <option value="">-- Seleccionar --</option>
                                                <option v-for="p in partsList" :key="p.IDPiezaExterior"
                                                    :value="p.IDPiezaExterior">{{ p.NombrePiezaExterior }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" class="form-control form-control-sm"
                                                v-model.number="newPart.cantidad" min="1">
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-success btn-sm w-100"
                                                @click="addPart">Agregar</button>
                                        </div>
                                    </div>

                                    <div v-if="selectedParts.length > 0">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Repuesto</th>
                                                    <th style="width: 100px;">Cant.</th>
                                                    <th style="width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(item, index) in selectedParts" :key="index">
                                                    <td class="text-wrap text-break">{{ item.nombre }}</td>
                                                    <td>{{ item.cantidad }}</td>
                                                    <td class="text-center"><button type="button"
                                                            class="btn btn-sm btn-danger" @click="removePart(index)"><i
                                                                class="fas fa-trash"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div v-else class="alert alert-info py-2">No se han asignado repuestos.</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary" :disabled="saving">{{ saving ?
                                    'Guardando...' : (isEdit ? 'Actualizar' : 'Crear') }}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const { createApp } = Vue;

        /**
         * Aplicación Vue para la gestión de Órdenes de Trabajo (Admin).
         * Maneja el listado, creación, edición y eliminación de órdenes.
         * También permite registrar vehículos nuevos directamente desde el formulario de orden.
         */
        createApp({
            data() {
                return {
                    orders: [],         // Lista de órdenes cargadas desde la API
                    clients: [],        // Lista de clientes para el selector
                    vehicles: [],       // Vehículos filtrados por cliente seleccionado
                    marcas: [],         // Lista de marcas para el nuevo vehículo
                    mechanics: [],      // Asignación de mecánicos
                    searchQuery: '',    // Texto del buscador en tiempo real
                    loading: false,     // Estado de carga de la tabla
                    saving: false,      // Estado de guardado del formulario (loading button)
                    isEdit: false,      // Flag para saber si estamos editando o creando una orden
                    showNewVehicle: false, // Controla la visibilidad de la sección "Nuevo Vehículo"

                    // Modelo del formulario principal de Orden
                    form: {
                        id: null,
                        fecha_ingreso: '',
                        run_cliente: '',
                        patente: '',
                        id_seguro: '',
                        id_mecanico: '',
                        observaciones: '',
                        estado: 'Pendiente'
                    },

                    insurances: [], // Lista de seguros del cliente
                    showNewInsurance: false,
                    newInsurance: { empresa: '', poliza: '' },

                    // Modelo para el formulario lateral de Crear Vehículo
                    newVehicle: {
                        patente: '',
                        marca: '',
                        modelo: '',
                        anio: '',
                        color: ''
                    },

                    modalInstance: null, // Referencia al modal de Bootstrap para controlarlo desde JS
                    laborList: [
                        { IDManoDeObra: 1, nombreTarea: 'Diagnóstico General', precioManoDeObra: 15000 },
                        { IDManoDeObra: 2, nombreTarea: 'Cambio de Aceite Full', precioManoDeObra: 35000 },
                        { IDManoDeObra: 3, nombreTarea: 'Cambio Neumático', precioManoDeObra: 10000 },
                        { IDManoDeObra: 4, nombreTarea: 'Reemplazo Parabrisas', precioManoDeObra: 45000 },
                        { IDManoDeObra: 5, nombreTarea: 'Cambio Luces/Focos', precioManoDeObra: 15000 },
                        { IDManoDeObra: 6, nombreTarea: 'Cambio Espejo', precioManoDeObra: 10000 },
                        { IDManoDeObra: 7, nombreTarea: 'Cambio Amortiguadores', precioManoDeObra: 35000 },
                        { IDManoDeObra: 8, nombreTarea: 'Cambio Batería', precioManoDeObra: 5000 },
                        { IDManoDeObra: 9, nombreTarea: 'Cambio Pastillas Freno', precioManoDeObra: 25000 },
                        { IDManoDeObra: 10, nombreTarea: 'Abolladura y Pintura (Paño)', precioManoDeObra: 60000 }
                    ],
                    selectedLabor: [],
                    selectedLaborId: '',

                    damageTypes: [
                        { TipoDano: 1, DescripcionDano: 'Pinchazo' },
                        { TipoDano: 2, DescripcionDano: 'Vidrio Roto' },
                        { TipoDano: 3, DescripcionDano: 'Foco Quemado' },
                        { TipoDano: 4, DescripcionDano: 'Espejo Roto' },
                        { TipoDano: 5, DescripcionDano: 'Suspensión Vencida' },
                        { TipoDano: 6, DescripcionDano: 'Batería Agotada' },
                        { TipoDano: 7, DescripcionDano: 'Frenos Gastados' },
                        { TipoDano: 8, DescripcionDano: 'Abolladura' },
                        { TipoDano: 9, DescripcionDano: 'Rayón' },
                        { TipoDano: 10, DescripcionDano: 'Fuga Aceite' }
                    ],
                    damageLocations: [
                        { IDUbicacionDano: 1, DescripcionUbicacion: 'Puerta Delantera Izq' },
                        { IDUbicacionDano: 2, DescripcionUbicacion: 'Puerta Delantera Der' },
                        { IDUbicacionDano: 3, DescripcionUbicacion: 'Puerta Trasera Izq' },
                        { IDUbicacionDano: 4, DescripcionUbicacion: 'Puerta Trasera Der' },
                        { IDUbicacionDano: 5, DescripcionUbicacion: 'Capó' },
                        { IDUbicacionDano: 6, DescripcionUbicacion: 'Techo' },
                        { IDUbicacionDano: 7, DescripcionUbicacion: 'Maletero' },
                        { IDUbicacionDano: 8, DescripcionUbicacion: 'Parachoques Delantero' },
                        { IDUbicacionDano: 9, DescripcionUbicacion: 'Parachoques Trasero' },
                        { IDUbicacionDano: 10, DescripcionUbicacion: 'Aleta Delantera Izq' },
                        { IDUbicacionDano: 11, DescripcionUbicacion: 'Aleta Delantera Der' },
                        { IDUbicacionDano: 12, DescripcionUbicacion: 'Llantas' }
                    ],
                    selectedDamages: [],
                    newDamage: { id_tipo: '', id_ubicacion: '', observacion: '' },

                    // REPUESTOS (Piezas)
                    partsList: [
                        { IDPiezaExterior: 1, NombrePiezaExterior: 'Neumático 17"' },
                        { IDPiezaExterior: 2, NombrePiezaExterior: 'Parabrisas Delantero' },
                        { IDPiezaExterior: 3, NombrePiezaExterior: 'Foco Delantero' },
                        { IDPiezaExterior: 4, NombrePiezaExterior: 'Foco Trasero' },
                        { IDPiezaExterior: 5, NombrePiezaExterior: 'Espejo Lateral' },
                        { IDPiezaExterior: 6, NombrePiezaExterior: 'Amortiguador' },
                        { IDPiezaExterior: 7, NombrePiezaExterior: 'Batería 12V' },
                        { IDPiezaExterior: 8, NombrePiezaExterior: 'Pastillas de Freno' },
                        { IDPiezaExterior: 9, NombrePiezaExterior: 'Aceite de Motor 5W30' },
                        { IDPiezaExterior: 10, NombrePiezaExterior: 'Filtro de Aceite' },
                        { IDPiezaExterior: 11, NombrePiezaExterior: 'Bujía' },
                        { IDPiezaExterior: 12, NombrePiezaExterior: 'Radiador' }
                    ],
                    selectedParts: [],
                    newPart: { id_pieza: '', cantidad: 1 }
                };
            },
            computed: {
                /**
                 * Filtra las órdenes visibles en la tabla según el texto de búsqueda.
                 * Busca coincidencias parciales en ID, Patente o Nombre del Cliente.
                 */
                filteredOrders() {
                    if (!this.searchQuery) return this.orders;
                    const q = this.searchQuery.toLowerCase();
                    return this.orders.filter(o =>
                        o.id.toString().includes(q) ||
                        o.patente.toLowerCase().includes(q) ||
                        (o.nombre_cliente && o.nombre_cliente.toLowerCase().includes(q))
                    );
                }
            },
            mounted() {
                // Inicializar Modal de Bootstrap
                this.modalInstance = new bootstrap.Modal(document.getElementById('orderModal'));

                // Cargar datos iniciales
                this.loadOrders();
                this.loadClients();
                this.loadMarcas();
                this.loadMechanics();
                this.loadLaborItems();
                this.loadDamageData();
                this.loadPartsList();
            },
            methods: {
                // --- MÉTODOS DE CARGA DE DATOS ---

                async loadPartsList() {
                    try {
                        let res = await fetch('../../controllers/API/inventario.php?action=parts_list&t=' + Date.now());
                        let json = await res.json();
                        if (json.success) this.partsList = json.data;
                    } catch (e) { }
                },

                async loadDamageData() {
                    try {
                        let res = await fetch('../../controllers/API/reparaciones.php?action=damage_types&t=' + Date.now());
                        let json = await res.json();
                        if (json.success) this.damageTypes = json.data;

                        res = await fetch('../../controllers/API/reparaciones.php?action=damage_locations&t=' + Date.now());
                        json = await res.json();
                        if (json.success) this.damageLocations = json.data;
                    } catch (e) { }
                },

                addDamage() {
                    if (!this.newDamage.id_tipo || !this.newDamage.id_ubicacion) return;

                    const tipo = this.damageTypes.find(t => t.TipoDano == this.newDamage.id_tipo);
                    const ubic = this.damageLocations.find(u => u.IDUbicacionDano == this.newDamage.id_ubicacion);

                    this.selectedDamages.push({
                        id_tipo: this.newDamage.id_tipo,
                        nombre_tipo: tipo ? tipo.DescripcionDano : '?',
                        id_ubicacion: this.newDamage.id_ubicacion,
                        nombre_ubicacion: ubic ? ubic.DescripcionUbicacion : '?',
                        observacion: this.newDamage.observacion
                    });

                    this.newDamage = { id_tipo: '', id_ubicacion: '', observacion: '' };
                },

                removeDamage(index) {
                    this.selectedDamages.splice(index, 1);
                },

                /** Obtiene todas las órdenes de trabajo desde el backend */
                async loadOrders() {
                    this.loading = true;
                    try {
                        const res = await fetch('../../controllers/API/reparaciones.php');
                        const json = await res.json();
                        if (json.success) this.orders = json.data;
                    } catch (e) { } finally { this.loading = false; }
                },

                /** Carga la lista de clientes activos */
                async loadClients() {
                    try {
                        const res = await fetch('../../controllers/API/clientes.php');
                        const json = await res.json();
                        if (json.success) this.clients = json.data;
                    } catch (e) { }
                },

                /** Carga las marcas de vehículos disponibles para el selector */
                async loadMarcas() {
                    try {
                        const res = await fetch('../../controllers/API/vehiculos.php?action=get_marcas');
                        const json = await res.json();
                        if (json.success) this.marcas = json.data.marcas;
                    } catch (e) { }
                },

                /** Carga la lista de mecánicos disponibles */
                async loadMechanics() {
                    try {
                        const res = await fetch('../../controllers/API/personal.php?rol=mecanico');
                        const json = await res.json();
                        if (json.success) this.mechanics = json.data;
                    } catch (e) { }
                },



                async loadInsurances() {
                    this.insurances = [];
                    //this.form.id_seguro = ''; // No resetear si estamos editando y ya tiene uno
                    if (this.form.run_cliente) {
                        try {
                            const res = await fetch(`../../controllers/API/seguros.php?run=${this.form.run_cliente}`);
                            const json = await res.json();
                            if (json.success) this.insurances = json.data;
                        } catch (e) { }
                    }
                },

                async saveNewInsurance() {
                    if (!this.newInsurance.empresa || !this.newInsurance.poliza) {
                        Swal.fire('Atención', 'Empresa y Póliza son obligatorios', 'warning');
                        return;
                    }
                    try {
                        const res = await fetch('../../controllers/API/seguros.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                run_cliente: this.form.run_cliente,
                                empresa: this.newInsurance.empresa,
                                poliza: this.newInsurance.poliza
                            })
                        });
                        const json = await res.json();
                        if (json.success) {
                            // Manually push to avoid server lag or race condition
                            const newInsObj = {
                                IDSeguro: Number(json.data.id),
                                EmpresaSeguro: this.newInsurance.empresa,
                                numeroPoliza: this.newInsurance.poliza
                            };
                            this.insurances.push(newInsObj);
                            this.form.id_seguro = newInsObj.IDSeguro;

                            Swal.fire({
                                title: 'Seguro Agregado',
                                text: 'El seguro ha sido registrado y seleccionado.',
                                icon: 'success',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                            this.showNewInsurance = false;
                            this.newInsurance = { empresa: '', poliza: '' };
                        } else {
                            Swal.fire('Error', json.message, 'error');
                        }
                    } catch (e) { Swal.fire('Error', 'Error al guardar seguro', 'error'); }
                },

                /**
                 * Se ejecuta cuando cambia el cliente seleccionado en el formulario.
                 * Carga los vehículos pertenecientes a ese cliente.
                 */
                async onClientChange() {
                    this.vehicles = [];
                    this.form.patente = ''; // Resetear patente seleccionada
                    await this.loadInsurances();
                    if (this.form.run_cliente) {
                        try {
                            const res = await fetch(`../../controllers/API/vehiculos.php?runCliente=${this.form.run_cliente}`);
                            const json = await res.json();
                            if (json.success) this.vehicles = json.data;
                        } catch (e) { }
                    }
                },

                /**
                 * Guarda un nuevo vehículo "al vuelo" desde el modal de orden.
                 * Incluye validaciones front-end para formato de datos.
                 */
                async saveNewVehicle() {
                    // Validar completitud
                    if (!this.newVehicle.patente || !this.newVehicle.marca || !this.newVehicle.modelo || !this.newVehicle.anio || !this.newVehicle.color) {
                        Swal.fire('Error', 'Todos los campos del vehículo son obligatorios', 'error');
                        return;
                    }

                    // Validar solo letras en Marca, Modelo, Color
                    const lettersOnlyRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
                    if (!lettersOnlyRegex.test(this.newVehicle.marca)) { Swal.fire('Error', 'La Marca solo debe contener letras.', 'error'); return; }
                    if (!lettersOnlyRegex.test(this.newVehicle.modelo)) { Swal.fire('Error', 'El Modelo solo debe contener letras.', 'error'); return; }
                    if (!lettersOnlyRegex.test(this.newVehicle.color)) { Swal.fire('Error', 'El Color solo debe contener letras.', 'error'); return; }

                    // Validar patente chilena (Formatos: AABB12 o AB1234)
                    const patenteRegex = /^([A-Z]{4}\d{2}|[A-Z]{2}\d{4})$/;
                    if (!patenteRegex.test(this.newVehicle.patente)) {
                        Swal.fire('Error', 'Formato de Patente Inválido. Debe ser 4 Letras + 2 Números (AABB12) o 2 Letras + 4 Números (AB1234).', 'error');
                        return;
                    }

                    // Validar formato año (4 dígitos)
                    const yearRegex = /^\d{4}$/;
                    if (!yearRegex.test(this.newVehicle.anio)) { Swal.fire('Error', "El Año debe ser un número de 4 dígitos", 'warning'); return; }

                    const yearToSend = parseInt(this.newVehicle.anio);

                    // Validar rango lógico de año (1995 - Año Actual + 1)
                    const currentYear = new Date().getFullYear();
                    if (yearToSend < 1995 || yearToSend > currentYear + 1) {
                        Swal.fire('Error', `El año del vehículo debe estar entre 1995 y ${currentYear + 1}`, 'error');
                        return;
                    }

                    // Enviar petición de creación
                    try {
                        const res = await fetch('../../controllers/API/vehiculos.php', {
                            method: 'POST',
                            body: JSON.stringify({
                                patente: this.newVehicle.patente,
                                marca_nombre: this.newVehicle.marca,
                                modelo_nombre: this.newVehicle.modelo,
                                anio: yearToSend,
                                color: this.newVehicle.color,
                                run_cliente: this.form.run_cliente
                            })
                        });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire({
                                title: 'Vehículo creado',
                                icon: 'success',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                            await this.onClientChange(); // Refrescar lista
                            this.form.patente = this.newVehicle.patente; // Seleccionar el nuevo
                            this.showNewVehicle = false; // Cerrar sub-form
                            this.newVehicle = { patente: '', marca: '', modelo: '', anio: '', color: '' }; // Limpiar
                        } else {
                            Swal.fire('Error', json.message, 'error');
                        }
                    } catch (e) { Swal.fire('Error', 'Error al guardar vehículo', 'error'); }
                },

                // --- MANEJO DE MODALES ---

                /** Abre el modal en modo Creación */
                openModalCreate() {
                    this.isEdit = false;
                    this.resetForm();
                    this.form.fecha_ingreso = new Date().toISOString().split('T')[0]; // Pre-llenar fecha hoy
                    this.modalInstance.show();
                },

                /** Abre el modal en modo Edición */
                async openModalEdit(o) {
                    this.isEdit = true;
                    this.resetForm();

                    // Cargar detalle completo desde API
                    try {
                        const res = await fetch(`../../controllers/API/reparaciones.php?id=${o.id}`);
                        const json = await res.json();

                        if (json.success && json.data) {
                            const fullOrder = json.data;

                            this.form = {
                                ...this.form,
                                id: fullOrder.id,
                                fecha_ingreso: fullOrder.fecha_ingreso,
                                run_cliente: fullOrder.run_cliente,
                                observaciones: fullOrder.descripcion,
                                estado: fullOrder.estado,
                                id_seguro: fullOrder.id_seguro || '',
                                id_mecanico: fullOrder.id_mecanico || ''
                            };

                            // Cargar listas
                            if (fullOrder.labor) {
                                this.selectedLabor = fullOrder.labor.map(l => ({
                                    id: l.id,
                                    nombre: l.nombre,
                                    precio: Number(l.precio) || 0,
                                    precio_unitario: Number(l.precio) || 0,
                                    horas: Number(l.horas) || 1
                                }));
                            }
                            if (fullOrder.parts) {
                                this.selectedParts = fullOrder.parts.map(p => ({
                                    id_pieza: p.id_pieza,
                                    nombre: p.nombre,
                                    cantidad: p.cantidad
                                }));
                            }
                            if (fullOrder.damages) {
                                this.selectedDamages = fullOrder.damages.map(d => ({
                                    id_tipo: d.id_tipo,
                                    id_ubicacion: d.id_ubicacion,
                                    nombre_tipo: d.DescripcionDano,
                                    nombre_ubicacion: d.DescripcionUbicacion,
                                    observacion: d.observacion
                                }));
                            }

                            await this.onClientChange();
                            this.form.patente = fullOrder.patente;
                            this.modalInstance.show();
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Error al cargar detalles de la orden', 'error');
                    }
                },

                /** Reinicia el formulario a su estado base */
                resetForm() {
                    this.form = { id: null, fecha_ingreso: '', run_cliente: '', patente: '', id_seguro: '', id_mecanico: '', observaciones: '', estado: 'Pendiente' };
                    this.showNewVehicle = false;
                    this.vehicles = [];
                },

                // --- CRUD ---

                /** Carga lista de tareas de mano de obra */
                async loadLaborItems() {
                    try {
                        const res = await fetch('../../controllers/API/reparaciones.php?action=labor&t=' + Date.now());
                        const json = await res.json();
                        if (json.success) this.laborList = json.data;
                    } catch (e) { }
                },

                addLabor() {
                    if (!this.selectedLaborId) return;
                    const item = this.laborList.find(l => l.IDManoDeObra == this.selectedLaborId);
                    if (item) {
                        const exists = this.selectedLabor.find(l => l.id == item.IDManoDeObra);
                        if (!exists) {
                            this.selectedLabor.push({
                                id: item.IDManoDeObra,
                                nombre: item.nombreTarea,
                                precio_unitario: item.precioManoDeObra,
                                precio: item.precioManoDeObra,
                                horas: 1
                            });
                        }
                    }
                    this.selectedLaborId = '';
                },

                removeLabor(index) {
                    this.selectedLabor.splice(index, 1);
                },

                /** Guarda la Orden (Create o Update) */
                async saveOrder() {
                    console.log("saveOrder triggered");
                    // alert("Debug: Botón Actualizar Presionado - Iniciando Validación");

                    try {
                        // --- VALIDACIONES ESTRICTAS ---
                        const emptyFields = [];
                        if (!this.form.fecha_ingreso) emptyFields.push('Fecha de Ingreso');
                        if (!this.form.estado) emptyFields.push('Estado');
                        if (!this.form.id_mecanico) emptyFields.push('Mecánico (Asignar Mecánico)');
                        if (!this.form.run_cliente) emptyFields.push('Cliente');
                        if (!this.form.patente) emptyFields.push('Vehículo (Patente)');

                        if (emptyFields.length > 0) {
                            Swal.fire('Campos Faltantes', 'Complete los siguientes datos generales: ' + emptyFields.join(', '), 'warning');
                            return;
                        }

                        // Validar Listas de Detalles (Obligatorio siempre)
                        if (this.selectedLabor.length === 0) {
                            Swal.fire('Faltan Detalles', 'Debe agregar al menos una Tarea en "Mano de Obra".', 'warning');
                            return;
                        }

                        if (this.selectedParts.length === 0) {
                            Swal.fire('Faltan Detalles', 'Debe agregar al menos un "Repuesto" a la orden.', 'warning');
                            return;
                        }

                        this.saving = true;
                        const method = this.isEdit ? 'PUT' : 'POST';

                        const payload = { ...this.form };
                        // Always send arrays to ensure backend syncs (deletes if empty)
                        payload.labor = this.selectedLabor.map(l => ({
                            id: l.id,
                            horas: Number(l.horas),
                            precio: Number(l.precio)
                        }));

                        payload.damages = this.selectedDamages.map(d => ({
                            id_tipo: Number(d.id_tipo),
                            id_ubicacion: Number(d.id_ubicacion),
                            observacion: d.observacion || ''
                        }));

                        payload.parts = this.selectedParts.map(p => ({
                            id_pieza: p.id_pieza,
                            cantidad: Number(p.cantidad)
                        }));

                        try {
                            const res = await fetch('../../controllers/API/reparaciones.php', {
                                method: method,
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const json = await res.json();
                            if (json.success) {
                                await Swal.fire({
                                    title: '¡Guardado!',
                                    text: 'La orden ha sido guardada exitosamente.',
                                    icon: 'success',
                                    confirmButtonColor: '#198754'
                                });
                                const modalEl = document.getElementById('orderModal');
                                const modal = bootstrap.Modal.getInstance(modalEl);
                                if (modal) modal.hide();
                                this.loadOrders();
                            } else {
                                Swal.fire('Error', json.message || 'Error desconocido', 'error');
                            }
                        } catch (e) { Swal.fire('Error', 'Error de conexión', 'error'); } finally { this.saving = false; }
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Error Interno', 'Error inesperado: ' + err.message, 'error');
                    }
                },

                /** Elimina una orden */
                async deleteOrder(o) {
                    const result = await Swal.fire({
                        title: '¿Estás seguro?',
                        text: "¿Eliminar esta orden? Esta acción no se puede deshacer.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar'
                    });

                    if (!result.isConfirmed) return;

                    try {
                        const res = await fetch(`../../controllers/API/reparaciones.php?id=${o.id}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (json.success) {
                            Swal.fire('Eliminado', 'Orden eliminada.', 'success');
                            this.loadOrders();
                        } else {
                            Swal.fire('Error', json.message, 'error');
                        }
                    } catch (e) { Swal.fire('Error', 'Error de conexión', 'error'); }
                },

                /** Helper para colores de etiquetas */
                getStatusClass(s) {
                    switch (s) { case 'Pendiente': return 'bg-warning text-dark'; case 'En Proceso': return 'bg-info text-dark'; case 'Completada': return 'bg-success'; case 'Cancelada': return 'bg-danger'; default: return 'bg-secondary'; }
                }
            }
        }).mount('#app');
    </script>
</body>

</html>