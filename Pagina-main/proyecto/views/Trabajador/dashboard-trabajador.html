<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mecánico - MIAUtomotriz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        fetch('../../controllers/API/auth.php?action=check_session')
            .then(res => res.json())
            .then(data => {
                if (!data.success || !data.user || data.user.rol !== 'mecanico') {
                    window.location.href = '../login.html';
                }
            })
            .catch(() => window.location.href = '../login.html');
    </script>
    <style>
        body.trabajador {
            --bg: #fffbf0;
        }

        body {
            background-color: var(--bg);
        }

        .card-header {
            color: #333;
            font-weight: bold;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body class="trabajador">
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-light mb-4 shadow bg-mechanic-yellow">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="../../img/logo.png" alt="logo" height="40" class="me-2">
                    <span>MIAUtomotriz</span>
                </a>
                <div class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item border-end border-dark pe-3 me-3 d-flex align-items-center">
                            <small id="user-display" class="fw-bold">Bienvenido</small>
                        </li>
                        <li class="nav-item"><a class="nav-link active" href="#">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link" href="reparaciones-trabajador.html">Mis Órdenes</a>
                        </li>
                        <li class="nav-item"><a class="nav-link text-danger"
                                href="../../controllers/API/auth.php?action=logout"><i class="fas fa-sign-out-alt"></i>
                                Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="p-4 mb-4 bg-white rounded shadow-sm border-start border-4 border-warning">
                <h2 class="h4 mb-0 text-dark">Panel de Mecánico</h2>
                <p class="text-muted mb-0">Hoy, {{ currentDate }}.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card stat-card bg-warning text-white h-100 shadow-sm border-0">
                        <div class="card-body text-center">
                            <h5 class="card-title">Mis Pendientes</h5>
                            <h2 class="display-4 fw-bold text-white">{{ dailyStats.pendientes || 0 }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card bg-info text-white h-100 shadow-sm border-0">
                        <div class="card-body text-center">
                            <h5 class="card-title">En Proceso</h5>
                            <h2 class="display-4 fw-bold text-white">{{ dailyStats.en_proceso || 0 }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card bg-success text-white h-100 shadow-sm border-0">
                        <div class="card-body text-center">
                            <h5 class="card-title">Completadas Hoy</h5>
                            <h2 class="display-4 fw-bold text-white">{{ dailyStats.completadas || 0 }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 text-center">
                <a href="reparaciones-trabajador.html" class="btn btn-dark btn-lg px-5 shadow-sm"><i
                        class="fas fa-clipboard-list me-2"></i> Ver Mis Órdenes</a>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 pt-3">
                            <h5 class="card-title mb-0 text-center">Mis Trabajos por Mes</h5>
                        </div>
                        <div class="card-body"><canvas id="chartTrabajo"></canvas></div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 pt-3">
                            <h5 class="card-title mb-0 text-center">Estado de Mis Órdenes</h5>
                        </div>
                        <div class="card-body"><canvas id="chartEstados"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() { return { dailyStats: { pendientes: 0, en_proceso: 0, completadas: 0 }, userEmail: '', currentDate: new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }), userId: null }; },
            mounted() { this.checkSession(); },
            methods: {
                async checkSession() {
                    try {
                        const res = await fetch('../../controllers/API/auth.php?action=check_session');
                        const json = await res.json();
                        if (json.success && json.user) {
                            if (json.user.rol !== 'mecanico') window.location.href = '../login.html';
                            this.userEmail = json.user.correo;
                            this.userId = json.user.IDUsuario || json.user.id;
                            const display = document.getElementById('user-display');
                            if (display) display.textContent = 'Mecánico: ' + json.user.correo;
                            this.loadStats();
                            this.initCharts();
                        } else { window.location.href = '../login.html'; }
                    } catch (e) { window.location.href = '../login.html'; }
                },
                async loadStats() {
                    try {
                        let url = '../../controllers/API/reparaciones.php?resumen=hoy';
                        if (this.userId) url += '&id_mecanico=' + this.userId;
                        const res = await fetch(url);
                        const json = await res.json();
                        if (json.success) this.dailyStats = json.data;
                    } catch (e) { }
                },
                async initCharts() {
                    const API_HELPERS = '../../controllers/API/helpers.php';
                    let params = '';
                    if (this.userId) params = '&id_mecanico=' + this.userId;

                    try {
                        const r1 = await fetch(API_HELPERS + '?data=stats' + params); const d1 = await r1.json();
                        if (d1.success) new Chart(document.getElementById('chartTrabajo'), { type: 'bar', data: { labels: d1.data.por_mes.map(i => i.mes), datasets: [{ label: 'Trabajos', data: d1.data.por_mes.map(i => i.total), backgroundColor: '#ffc107', borderRadius: 4 }] } });
                        const r2 = await fetch(API_HELPERS + '?data=estados' + params); const d2 = await r2.json();
                        if (d2.success) new Chart(document.getElementById('chartEstados'), { type: 'doughnut', data: { labels: d2.data.map(i => i.estado), datasets: [{ data: d2.data.map(i => i.cantidad), backgroundColor: ['#dc3545', '#0dcaf0', '#198754', '#ffc107', '#6c757d'] }] } });
                    } catch (e) { }
                }
            }
        }).mount('#app');
    </script>
</body>

</html>