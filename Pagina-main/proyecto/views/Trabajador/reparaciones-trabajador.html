<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Órdenes - MiaAutomotriz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        fetch('../../controllers/API/auth.php?action=check_session')
            .then(res => res.json())
            .then(data => {
                if (!data.success || !data.user || data.user.rol !== 'mecanico') {
                    window.location.href = '../login.html';
                } else {
                    const display = document.getElementById('user-display');
                    if (display) display.textContent = 'Mecánico: ' + data.user.correo;
                }
            })
            .catch(() => window.location.href = '../login.html');
    </script>
    <style>
        body.trabajador {
            --bg: #fffbf0;
        }

        body {
            background-color: var(--bg);
        }

        .card-header {
            color: #333;
            font-weight: bold;
        }
    </style>
</head>

<body class="trabajador">

    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-light mb-4 shadow bg-mechanic-yellow">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="../../img/logo.png" alt="logo" height="40" class="me-2">
                    <span>MIAUtomotriz</span>
                </a>
                <div class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item border-end border-dark pe-3 me-3 d-flex align-items-center">
                            <small id="user-display" class="fw-bold">Bienvenido</small>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="dashboard-trabajador.html">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#">Mis Órdenes</a></li>
                        <li class="nav-item"><a class="nav-link text-danger"
                                href="../../controllers/API/auth.php?action=logout"><i class="fas fa-sign-out-alt"></i>
                                Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-tools me-2"></i>Mis Órdenes de Trabajo</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3"><input type="text" class="form-control"
                            placeholder="Buscar por Patente, Cliente o ID..." v-model="searchQuery"></div>
                    <!-- Tabla de ordenes -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Vehículo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="loading">
                                    <td colspan="6" class="text-center">Cargando...</td>
                                </tr>
                                <tr v-else-if="filteredOrders.length === 0">
                                    <td colspan="6" class="text-center text-muted">No se encontraron órdenes.</td>
                                </tr>
                                <tr v-else v-for="order in filteredOrders" :key="order.id">
                                    <td><strong>{{ order.id }}</strong></td>
                                    <td>{{ order.fecha_ingreso }}</td>
                                    <td>
                                        <div>{{ order.nombre_cliente }}</div>
                                    </td>
                                    <td>
                                        <div class="badge bg-secondary">{{ order.patente }}</div><small
                                            class="d-block text-muted">{{ order.marca }} {{ order.modelo }}</small>
                                    </td>
                                    <td><span :class="['badge', getStatusClass(order.estado)]">{{ order.estado }}</span>
                                    </td>
                                    <td><button class="btn btn-sm btn-outline-dark" @click="openModalEdit(order)"
                                            title="Ver detalles de la orden"><i class="fas fa-eye"></i> Ver
                                            Detalles</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para ver orden -->
        <div class="modal fade" id="orderModal" tabindex="-1" ref="orderModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-mechanic-yellow">
                        <h5 class="modal-title">Detalles de la Orden #{{ form.id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent>
                            <div class="alert alert-secondary py-2">
                                <small class="d-block"><strong>Vehículo:</strong> {{ form.vehiculoInfo }}</small>
                                <small class="d-block"><strong>Cliente:</strong> {{ form.clienteInfo }}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" v-model="form.estado" disabled>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="En Proceso">En Proceso</option>
                                    <option value="Completada">Completada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Observaciones / Avances</label>
                                <textarea class="form-control" rows="5" v-model="form.observaciones"
                                    readonly></textarea>
                                <div class="form-text">Detalles del trabajo realizado.</div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return { orders: [], userId: null, searchQuery: '', loading: false, form: { id: null, estado: '', observaciones: '', vehiculoInfo: '', clienteInfo: '', fecha_ingreso: '', patente: '', id_seguro: '' }, modalInstance: null };
            },
            computed: {
                filteredOrders() {
                    if (!this.searchQuery) return this.orders;
                    const q = this.searchQuery.toLowerCase();
                    return this.orders.filter(o => o.id.toString().includes(q) || o.patente.toLowerCase().includes(q) || (o.nombre_cliente && o.nombre_cliente.toLowerCase().includes(q)));
                }
            },
            async mounted() {
                this.modalInstance = new bootstrap.Modal(document.getElementById('orderModal'));
                await this.checkUser();
                this.loadOrders();
            },
            methods: {
                async checkUser() {
                    try {
                        const res = await fetch('../../controllers/API/auth.php?action=check_session');
                        const data = await res.json();
                        if (data.success && data.user) this.userId = data.user.id;
                    } catch (e) { }
                },
                async loadOrders() {
                    this.loading = true;
                    try {
                        let url = '../../controllers/API/reparaciones.php';
                        if (this.userId) url += `?id_mecanico=${this.userId}`;
                        const res = await fetch(url);
                        const json = await res.json();
                        if (json.success) this.orders = json.data;
                    } catch (e) { } finally { this.loading = false; }
                },
                openModalEdit(order) {
                    this.form = { ...this.form, id: order.id, estado: order.estado, observaciones: order.descripcion, vehiculoInfo: `${order.marca} ${order.modelo} [${order.patente}]`, clienteInfo: `${order.nombre_cliente}`, fecha_ingreso: order.fecha_ingreso, patente: order.patente, id_seguro: order.id_seguro };
                    this.modalInstance.show();
                },
                getStatusClass(s) { switch (s) { case 'Pendiente': return 'bg-warning text-dark'; case 'En Proceso': return 'bg-info text-dark'; case 'Completada': return 'bg-success'; case 'Cancelada': return 'bg-danger'; default: return 'bg-secondary'; } }
            }
        }).mount('#app');
    </script>
</body>

</html>